<p-toolbar styleClass="mb-6">
    <ng-template #start>
        <p-button label="Nuevo" icon="pi pi-plus" severity="secondary" class="mr-2" (onClick)="openNew()" />
    </ng-template>

    <ng-template #end>
        <p-button label="Actualizar" icon="pi pi-refresh" severity="secondary" [loading]="loading" (onClick)="loadAttributes()" />
    </ng-template>
</p-toolbar>

<p-card header="" [style]="{ 'border-radius': '6px' }">
    <p-table
        #dt
        [value]="attributes()"
        [rows]="10"
        [loading]="loading"
        [paginator]="true"
        [globalFilterFields]="['name','dataType','status']"
        [tableStyle]="{ 'min-width': '100%' }"
        [(selection)]="selectedAttributes"
        [rowHover]="true"
        dataKey="id"
        currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} atributos"
        [showCurrentPageReport]="true"
        [rowsPerPageOptions]="[10,20,30]"
        showGridlines
        [size]="'small'"
    >
        <ng-template #caption>
            <div class="flex items-center justify-between">
                <h5 class="m-0">Atributos</h5>
                <p-iconfield>
                    <p-inputicon styleClass="pi pi-search" />
                    <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Buscar..." />
                </p-iconfield>
            </div>
        </ng-template>

        <ng-template #header>
            <tr>
                <th pSortableColumn="name" style="width: 40%">
                    Nombre
                    <p-sortIcon field="name" />
                </th>
                <th pSortableColumn="dataType" style="width: 25%">
                    Tipo
                    <p-sortIcon field="dataType" />
                </th>
                <th pSortableColumn="status" style="width: 25%">
                    Estado
                    <p-sortIcon field="status" />
                </th>
                <th style="width: 10%">Ope.</th>
            </tr>
        </ng-template>

        <ng-template #body let-attr>
            <tr>
                <td>{{ attr.name }}</td>
                <td>
                    <p-tag [value]="attr.dataType" severity="info" />
                </td>
                <td>
                    <p-tag [value]="attr.status" [severity]="getSeverity(attr.status)" />
                </td>
                <td>
                    <p-button icon="pi pi-pencil" class="mr-2" [rounded]="true" [outlined]="true" (click)="editAttribute(attr)" />
                    <p-button icon="pi pi-trash" severity="danger" [rounded]="true" [outlined]="true" (click)="deleteAttribute(attr)" />
                </td>
            </tr>
        </ng-template>
    </p-table>
</p-card>

<p-dialog [(visible)]="attributeDialog" [position]="'center'" [style]="{ width: '54rem' }" [header]="attribute?.id ? 'Actualizar Atributo' : 'Nuevo Atributo'" [modal]="true">
    <ng-template #content>
        <form [formGroup]="form" class="grid grid-cols-12 gap-6 md:grid-cols-12">
            <div class="col-span-12 md:col-span-5">
                <label for="name" class="block mb-3 font-bold">Nombre (*)</label>
                <input id="name" type="text" pInputText formControlName="name" required autofocus fluid />
                @if (submitted && form.controls.name.errors?.['required']) {
                <small class="text-red-500"> Nombre es requerido. </small>
                } @if (submitted && form.controls.name.errors?.['minlength']) {
                <small class="text-red-500"> Mínimo 2 caracteres. </small>
                }
            </div>

            <div class="col-span-12 md:col-span-4">
                <label for="dataType" class="block mb-3 font-bold">Tipo (*)</label>
                <p-select id="dataType" formControlName="dataType" [options]="dataTypeOptions" appendTo="body" optionLabel="name" optionValue="code" placeholder="Seleccione un tipo" class="w-full" />
                <small class="text-surface-500"> @if (form.controls.dataType.value === 'number') { Valor numérico libre. } @else if (form.controls.dataType.value === 'boolean') { Valor verdadero/falso. } @else { Texto libre. } </small>
            </div>

            <div class="col-span-12 md:col-span-3">
                <label for="status" class="block mb-3 font-bold">Estado (*)</label>
                <p-select id="status" formControlName="status" [options]="statusOptions" appendTo="body" optionLabel="name" optionValue="code" placeholder="Seleccione un estado" class="w-full" />
                @if (submitted && form.controls.status.errors?.['required']) {
                <small class="text-red-500"> Estado es requerido. </small>
                }
            </div>
        </form>

        <!-- Sección de VALORES solo para SELECT/MULTISELECT -->
        <div class="mt-6">
            <div class="flex items-center justify-between mb-3">
                <h6 class="m-0 font-bold">Valores del atributo</h6>
                <p-button label="Agregar" icon="pi pi-plus" size="small" (onClick)="addValueRow()" />
            </div>

            <div class="border rounded-md overflow-hidden">
                <table class="w-full">
                    <thead class="bg-surface-100">
                        <tr>
                            <th class="px-3 py-2 text-left" style="width: 45%">Valor</th>
                            <th class="px-3 py-2 text-left" style="width: 15%">Ope.</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let fg of valuesForm.controls; let i = index" class="border-t">
                            <td class="px-3 py-2">
                                <!-- Muestra el campo según dataType -->
                                @if (form.controls.dataType.value === 'string') {
                                <input type="text" pInputText [formControl]="fg.controls.valueString" placeholder="Valor (texto)" />
                                } @else if (form.controls.dataType.value === 'number') {
                                <p-inputNumber [formControl]="fg.controls.valueNumber" inputId="num-{{ i }}" mode="decimal" [minFractionDigits]="0" [maxFractionDigits]="4"> </p-inputNumber>
                                } @else if (form.controls.dataType.value === 'boolean') {
                                <p-select [formControl]="fg.controls.valueBoolean" appendTo="body" [options]="[{ name: 'True', code: true }, { name: 'False', code: false }]" optionLabel="name" optionValue="code" class="w-40"> </p-select>
                                }
                            </td>

                            <td class="px-3 py-2">
                                <p-button icon="pi pi-trash" severity="danger" [rounded]="true" [outlined]="true" (click)="removeValueRow(i)" />
                            </td>
                        </tr>

                        @if (valuesForm.length === 0) {
                        <tr>
                            <td class="px-3 py-3 text-surface-500" colspan="2">Sin valores. Agrega al menos uno.</td>
                        </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </ng-template>

    <ng-template #footer>
        <p-button label="Cancelar" icon="pi pi-times" text (click)="hideDialog()" />
        <p-button [disabled]="loading" [loading]="loading" [label]="loading ? (attribute?.id ? 'Actualizando...' : 'Guardando...') : attribute?.id ? 'Actualizar' : 'Guardar'" icon="pi pi-check" (click)="saveAttribute()" />
    </ng-template>
</p-dialog>

<p-confirmdialog key="confirm" [style]="{ width: '450px' }" />
