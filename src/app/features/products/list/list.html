<p-toolbar styleClass="mb-6">
    <ng-template #start>
        <p-button label="Nuevo" icon="pi pi-plus" severity="secondary" class="mr-2" (onClick)="openNew()" />
    </ng-template>

    <ng-template #end>
        <p-button label="Actualizar" icon="pi pi-refresh" severity="secondary" [loading]="loading" (onClick)="loadProducts()" />
    </ng-template>
</p-toolbar>

<p-card header="" [style]="{ 'border-radius': '6px' }">
    <p-table
        #dt
        [value]="products()"
        [rows]="10"
        [loading]="loading"
        [paginator]="true"
        [globalFilterFields]="['description','status','category.description']"
        [tableStyle]="{ 'min-width': '100%' }"
        [(selection)]="selectedProducts"
        [rowHover]="true"
        dataKey="id"
        currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} productos"
        [showCurrentPageReport]="true"
        [rowsPerPageOptions]="[10,20,30]"
        showGridlines
        [size]="'small'"
    >
        <ng-template #caption>
            <div class="flex items-center justify-between">
                <h5 class="m-0">Productos</h5>
                <p-iconfield>
                    <p-inputicon styleClass="pi pi-search" />
                    <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Buscar..." />
                </p-iconfield>
            </div>
        </ng-template>

        <ng-template #header>
            <tr>
                <th style="width: 12%">Imagen</th>
                <th pSortableColumn="description" style="width: 38%">
                    Descripción
                    <p-sortIcon field="description" />
                </th>
                <th pSortableColumn="category.description" style="width: 20%">
                    Categoría
                    <p-sortIcon field="category.description" />
                </th>
                <th pSortableColumn="price" style="width: 15%">
                    Precio
                    <p-sortIcon field="price" />
                </th>
                <th pSortableColumn="status" style="width: 15%">
                    Estado
                    <p-sortIcon field="status" />
                </th>
                <th style="width: 10%">Ope.</th>
            </tr>
        </ng-template>

        <ng-template #body let-prod>
            <tr>
                <td>
                    <p-image
                        [src]="(prod.productImages && prod.productImages[0]?.image) || 'https://via.placeholder.com/120x80.png?text=Imagen'"
                        alt="Imagen"
                        [preview]="true"
                        [style]="{ width: '64px', height: '48px', objectFit: 'cover', borderRadius: '6px' }"
                    >
                    </p-image>
                </td>
                <td>{{ prod.description }}</td>
                <td>{{ prod.category?.description }}</td>
                <td>{{ prod.price | number:'1.2-2' }}</td>
                <td>
                    <p-tag [value]="prod.status" [severity]="getSeverity(prod.status)" />
                </td>
                <td>
                    <p-button icon="pi pi-pencil" class="mr-2" [rounded]="true" [outlined]="true" (click)="editProduct(prod)" />
                    <p-button icon="pi pi-trash" severity="danger" [rounded]="true" [outlined]="true" (click)="deleteProduct(prod)" />
                </td>
            </tr>
        </ng-template>
    </p-table>
</p-card>

<p-dialog [(visible)]="productDialog" [position]="'center'" [style]="{ width: '54rem' }" [header]="product?.id ? 'Actualizar Producto' : 'Nuevo Producto'" [modal]="true">
    <ng-template #content>
        <form [formGroup]="form" class="grid grid-cols-12 gap-6 md:grid-cols-12">
            <div class="col-span-12 md:col-span-6">
                <label for="categoryId" class="block mb-3 font-bold">Categoría (*)</label>
                <p-select id="categoryId" formControlName="categoryId" [options]="categories()" appendTo="body" optionLabel="description" optionValue="id" placeholder="Seleccione una categoría" class="w-full" />
                @if (submitted && form.controls.categoryId.errors?.['required']) {
                <small class="text-red-500"> Categoría es requerida. </small>
                }
            </div>

            <div class="col-span-12 md:col-span-6">
                <label for="status" class="block mb-3 font-bold">Estado (*)</label>
                <p-select id="status" formControlName="status" [options]="statusOptions" appendTo="body" optionLabel="name" optionValue="code" placeholder="Seleccione un estado" class="w-full" />
                @if (submitted && form.controls.status.errors?.['required']) {
                <small class="text-red-500"> Estado es requerido. </small>
                }
            </div>

            <div class="col-span-12">
                <label for="description" class="block mb-3 font-bold">Descripción (*)</label>
                <input id="description" type="text" pInputText formControlName="description" required fluid />
                @if (submitted && form.controls.description.errors?.['required']) {
                <small class="text-red-500"> Descripción es requerida. </small>
                } @if (submitted && form.controls.description.errors?.['minlength']) {
                <small class="text-red-500"> Mínimo 3 caracteres. </small>
                }
            </div>

            <div class="col-span-12 md:col-span-6">
                <label for="price" class="block mb-3 font-bold">Precio (*)</label>
                <p-inputNumber inputId="price" formControlName="price" mode="decimal" [min]="0" [minFractionDigits]="0" [maxFractionDigits]="2"></p-inputNumber>
                @if (submitted && form.controls.price.errors?.['required']) {
                <small class="text-red-500 block"> Precio es requerido. </small>
                }
            </div>

            <!-- Atributos y valores -->
            <div class="col-span-12">
                <div class="flex justify-between items-center">
                    <label class="block mb-3 font-bold">Atributos y valores</label>
                    <div class="mt-3 flex items-center gap-2">
                        <p-button label="Agregar combinación" icon="pi pi-plus" size="small" (onClick)="addCurrentSelection()"> </p-button>
                    </div>
                </div>

                <!-- 1) Elegir atributo activo -->
                <div class="grid grid-cols-12 gap-4">
                    <!-- Selector de atributo -->
                    <div class="col-span-12 md:col-span-6">
                        <label class="block mb-2 text-sm font-medium">Atributo</label>
                        <p-select [options]="attributes()" [formControl]="selectedAttributeId" appendTo="body" optionLabel="name" optionValue="id" placeholder="Seleccione un atributo" class="w-full"> </p-select>
                        <small class="text-surface-500">Selecciona un atributo para ver sus valores.</small>
                    </div>

                    <!-- Lista de valores + botón -->
                    <div class="col-span-12 md:col-span-6 flex flex-col">
                        <label class="block mb-2 text-sm font-medium">Valores</label>
                        <p-listbox [options]="(currentAttributeValues$ | async) || []" [multiple]="true" [metaKeySelection]="false" [listStyle]="{ 'max-height': '220px' }" [formControl]="currentAttrValueIds" optionValue="id" class="flex-1">
                            <ng-template let-opt pTemplate="item"> {{ avLabel(opt) }} </ng-template>
                        </p-listbox>

                        <small class="text-surface-500 mt-1">Marca uno o varios valores y presiona “Agregar combinación”.</small>
                    </div>
                </div>
                <!-- 3) Vista agrupada de seleccionados (por atributo) -->
                <div class="mt-4 border rounded-md p-3">
                    <div class="font-semibold mb-2">Seleccionados:</div>

                    <ng-container *ngIf="form.controls.attributeValueIds.value?.length; else noSel">
                        <div class="space-y-3">
                            <div *ngFor="let attr of attributes()">
                                <!-- Mostrar solo si hay algo seleccionado para ese atributo -->
                                <ng-container *ngIf="selectedByAttribute.get(attr.id)?.length">
                                    <div class="flex items-center justify-between">
                                        <div class="font-medium">{{ attr.name }}</div>
                                        <p-button label="Limpiar" size="small" severity="secondary" (onClick)="clearAttributeSelection(attr.id)"></p-button>
                                    </div>

                                    <div class="mt-2 flex flex-wrap gap-2">
                                        <ng-container *ngFor="let vid of (selectedByAttribute.get(attr.id) || [])">
                                            <p-tag [value]="avLabel(getValueObj(attr.id, vid)!)" severity="info" styleClass="mr-1"> </p-tag>
                                            <button pButton type="button" icon="pi pi-times" class="p-button-text p-button-sm" (click)="removeSelectedValue(attr.id, vid)"></button>
                                        </ng-container>
                                    </div>
                                </ng-container>
                            </div>
                        </div>
                    </ng-container>

                    <ng-template #noSel>
                        <div class="text-surface-500">Aún no hay valores seleccionados.</div>
                    </ng-template>
                </div>
            </div>

            <div class="col-span-12">
                <label class="block mb-3 font-bold">Imágenes</label>
                <div class="flex items-start gap-4 flex-wrap">
                    <!-- preview existentes + nuevas -->
                    <ng-container *ngFor="let src of imagePreviews; let idx = index">
                        <p-image [src]="src" alt="Imagen" [preview]="true" class="rounded-xl overflow-hidden border border-surface-200/60" [style]="{width:'120px', height:'90px', objectFit:'cover'}"> </p-image>
                    </ng-container>

                    <div class="flex flex-col gap-2">
                        <button pButton pRipple type="button" class="p-button-outlined rounded-xl" (click)="fileInput?.click()">Subir imágenes</button>
                        <small class="text-surface-500">Formatos: JPG, PNG, WEBP. Puedes seleccionar varias.</small>
                        <input #fileInput type="file" accept="image/*" class="hidden" multiple (change)="onImagesChange($event)" />
                    </div>
                </div>
            </div>
        </form>
    </ng-template>

    <ng-template #footer>
        <p-button label="Cancelar" icon="pi pi-times" text (click)="hideDialog()" />
        <p-button [disabled]="loading" [loading]="loading" [label]="loading ? (product?.id ? 'Actualizando...' : 'Guardando...') : product?.id ? 'Actualizar' : 'Guardar'" icon="pi pi-check" (click)="saveProduct()" />
    </ng-template>
</p-dialog>

<p-confirmdialog key="confirm" [style]="{ width: '450px' }" />
